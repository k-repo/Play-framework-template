#{extends 'main.html' /}
#{set title:'Search results' /}
#{set menuactivation:'no' /}






<div class="row">
    <div id="mapinfo">
        <span id="lblPosition">Searchig...</span>
        <br/>
        <span id="lblNrUpdates">0</span>
        <br />
        <span id="lblErrorMessage"></span>
    </div>
    <br>
    <br>
    <br>
    <div id="map_canvas" style="width:800px; height:500px"></div>
</div>




<script type="text/javascript"
        src="http://maps.google.com/maps/api/js?sensor=true&language=nl">
</script>




<script type="text/javascript">
    var browserSupportFlag = true;
    var map;
    var initialLocation = new google.maps.LatLng(45.432096, 28.061957);

    var siberia = new google.maps.LatLng(60, 105);
    var newyork = new google.maps.LatLng(40.69847032728747, -73.9514422416687);
    var currentIcon = new google.maps.MarkerImage('http://85.255.207.58/CityHighlights/images/markers/player.png',
            // This marker is 20 pixels wide by 32 pixels tall.
            new google.maps.Size(25, 68),
            // The origin for this image is 0,0.
            new google.maps.Point(0, 0),
            // The anchor for this image is the base of the flagpole at 0,32.
            new google.maps.Point(12, 62));
    var currentMarker = null;
    var nr_updates = 0;
    var watchId;

    function initialize() {
        var myOptions = {
            zoom: 14,
            center: initialLocation,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map(document.getElementById("map_canvas"),
                myOptions);

        getCurrentPosition();

    }

    function getCurrentPosition() {
        // Try W3C Geolocation (Preferred)
//      if (window.blackberry && blackberry.location.GPSSupported) {
//          alert("Blackberry api is used");
//          // RIGHT: pass a string that calls our method
//          blackberry.location.onLocationUpdate("BlackberrylocationCB()");
//          // set to Autonomous mode
//          blackberry.location.setAidMode(2);
//          //refresh the location
//          blackberry.location.refreshLocation();
//      } else {

        if (navigator.geolocation) {
            browserSupportFlag = true;
            navigator.geolocation.getCurrentPosition(function(position) {
                document.getElementById("lblPosition").innerHTML = "Position: " + position.coords.latitude.toFixed(6) + "," + position.coords.longitude.toFixed(6) + ", " + position.coords.accuracy;
                initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

                moveMarker(initialLocation);
                var geolocate = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);

                //var infowindow = new google.maps.InfoWindow({
                //    map: map,
                //    position: geolocate,
                //    content:
                //            'Latitude: ' + position.coords.latitude +
                //            'Longitude: ' + position.coords.longitude
                //});

                map.setCenter(geolocate);
            }, function() {
                handleNoGeolocation(browserSupportFlag);
            }, { enableHighAccuracy: true, maximumAge: 0, timeout: 30000 });
            // Try Google Gears Geolocation
            //      } else if (google.gears) {
            //          browserSupportFlag = true;
            //          var geo = google.gears.factory.create('beta.geolocation');
            //          geo.getCurrentPosition(function(position) {
            //          initialLocation = new google.maps.LatLng(position.latitude, position.longitude);
            //              moveMarker(initialLocation);
            //          }, function() {
            //              handleNoGeoLocation(browserSupportFlag);
            //          });
            // Browser doesn't support Geolocation
        } else {
            browserSupportFlag = false;
            handleNoGeolocation(browserSupportFlag);
        }

        if (browserSupportFlag) {
            watchId = navigator.geolocation.watchPosition(function(position) {
                        document.getElementById("lblPosition").innerHTML = "Position: " + position.coords.latitude.toFixed(6) + "," + position.coords.longitude.toFixed(6) + ", " + position.coords.accuracy;
                        if (position.coords.accuracy <= 50) {
                            initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                            moveMarker(initialLocation);
                        }
                    }, function() {
                        handleNoGeolocation(browserSupportFlag);
                    },
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 30000 });
        }
//      }
    }


    function BlackberrylocationCB() {
        alert("lat=" + blackberry.location.latitude + "; long=" + blackberry.location.longitude);
        initialLocation = new google.maps.LatLng(blackberry.location.latitude, blackberry.location.longitude);
        moveMarker(initialLocation);
    }

    function errorCallback(error) {
        document.getElementById("lblErrorMessage").innerHTML = error.message;
    }

    function handleNoGeolocation(errorFlag) {
        if (errorFlag == true) {
            document.getElementById("lblErrorMessage").innerHTML = "Geolocation service failed.";
            initialLocation = newyork;
        } else {
            document.getElementById("lblErrorMessage").innerHTML = "Your browser doesn't support geolocation. We've placed you in Siberia.";
            initialLocation = siberia;
        }
        map.setCenter(initialLocation);
    }

    function moveMarker(loc) {
        if (currentMarker == null) {
            currentMarker = new google.maps.Marker({
                position: loc,
                draggable: false,
                map: map
            });

            map.setCenter(loc);
        } else {
            currentMarker.setPosition(loc);
            map.setCenter(loc);
        }
        nr_updates++;
        document.getElementById("lblNrUpdates").innerHTML = "Nr updates: " + nr_updates;
        document.getElementById("lblErrorMessage").innerHTML = "";
    }
</script>


<script type="text/javascript">
    window.onload = function() {
        initialize();
    }
</script>